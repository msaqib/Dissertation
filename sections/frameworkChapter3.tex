\chapter{A generalized model for electricity cost optimization}
\label{chap:framework} In Chapter~\ref{chap:background}, we observed that there are several similarities and a few subtle differences between geo-diverse data center and cellular networks in terms of their power consumption models. We proposed a generic view of geo-diverse data centers and cellular networks as a collection of resources that are used to handle client workload. We also saw that their power consumption may be modeled as an affine function of the workload. In this chapter, we will use this generic model to formulate a generic optimization problem that minimizes electricity cost for both these networks. Our generic power consumption model and the corresponding electricity cost optimization problem incorporates the subtle differences, as discussed in section~\ref{sec:chap2:comparison}, between the data centers and cellular networks.


\section{Optimization problem model} %Discuss how different network types can periodically use RP and WR to minimize electricity costs. Show that this problem is NP-Hard. Describe the concept of network state and motivate a state trajectory optimization problem. Describe transition costs and formulate a mathematical optimization problem.
In order to develop a generalized optimization problem for minimizing electricity cost, we use an illustrative example shown in Figure~\ref{fig:mappingexample}. The example uses a test tube to represent a network site and marbles to represent a unit workload. The network site would be a data center in the context of geo-diverse data center operator, whereas it would be a BTS in the case of a cellular operator. Similarly, the workload unit would be a client request in the data center context, whereas it would be a call in a cellular network setting. The operator's goal is to assign workload to network resources and, if needed, periodically update this assignment in response to variations in workload.

\begin{figure}
\centering
\includegraphics[width=1\textwidth]{pics/mappingexample-v2.eps}
\caption{An example of mapping variable workload to capacity-limited network sites with geo-temporal diversity in electricity prices. Three consecutive intervals $t_1$, $t_2$ and $t_3$ are considered. Workload and electricity prices may only change between two consecutive intervals. (a) Workload considered in this example. (b) Electricity prices for the locations at which the two network sites are situated. (c) A uniform mapping of workload to network sites does not exploit electricity price diversity. (d) Mapping workload to network sites in order of their current electricity price. Due to lack of energy proportionality, only slight savings in electricity cost are possible. (e) Deactivating idle resources alongwith the resource mapping strategy of (d) may result in significant electricity cost savings.}
\label{fig:mappingexample}
\end{figure}

We consider the largest possible quantum of time for which the electricity prices remain fixed and term each such quantum as an \textit{interval}. We assume that workload for several consecutive intervals is known and term this sequence of intervals as a planning window. The example in Figure~\ref{fig:mappingexample} demonstrates three different ways (shown in parts c, d and e) of mapping this workload to two network sites situated at different locations, over a planning window consisting of three intervals centered at $t_1$, $t_2$ and $t_3$. In each interval, we assume that the workload is geographically split such that half of it originates near each of the two sites. For this example, we consider temporal variation in workload as shown in Figure~\ref{fig:mappingexample} (a). Meanwhile, Figure~\ref{fig:mappingexample} (b) shows the geo-temporal variation in electricity prices for the two network sites.

One possible operational strategy is to map each workload unit to the nearest available site as shown in Figure~\ref{fig:mappingexample} (c). In a sense, this is the default strategy in cellular networks, whereby a call is handled by the BTS from which the mobile station (MS) receives the strongest radio signal\footnote{Signal from the physically nearest BTS may be weakened considerably due to natural or man-made obstructions. In such cases, the nearest BTS may not be the one from which the strongest signal is received. Hence, we take "nearest" to mean the BTS from which the MS receives the strongest signal}. In geo-diverse data center settings, this mapping strategy is also often the default strategy because it minimizes the access latency for all clients\footnote{Network latency has been shown to have a strong correlation with the physical shortest path distance between two locations on the globe~\cite{dina:p2pdelay:infocom:2004}. So, the commonly understood physical measure of "shortest" applies in this case.}. 

The above workload-site mapping strategy pays no attention to geo-diversity in electricity prices. We can exploit geo-diversity in electricity prices to reduce the electricity cost over the planning window by mapping more workload to network resources at sites with cheaper electricity. To this end, we must change the way workload is mapped to resources as the electricity prices at various locations change. We term such changes in workload-site mapping as Workload Relocation (WR). 

Figure~\ref{fig:mappingexample} (d) shows a mapping strategy that uses WR to map as much workload as possible to resources at sites with cheaper electricity. In interval $t_1$, since the cumulative workload equals the total network capacity, both network sites will be operating at full capacity. Accordingly, there is no opportunity to reduce electricity costs using WR or RP. In interval $t_2$, on the other hand, as shown in Figure~\ref{fig:mappingexample} (d), we may use WR to move all workload to network site B, which is situated at the location with the cheapest electricity price, thereby reducing electricity cost for that interval as compared to the default workload-mapping strategy. Similarly, in interval $t_3$ WR may be used to shift workload such that the cheaper site A is loaded to full capacity and the remaining workload is mapped to site B. 

Due to lack of energy proportionality in networks, the power consumption of idle sites is a large fraction of their peak power consumption. Hence, consolidation of workload to cheaper locations offers a limited benefit in terms of reducing electricity cost compared to the default workload-mapping strategy. To avail considerable savings in electricity cost, one must use resource pruning (RP), i.e., deactivate idle resources. Notice that in the default workload-site mapping strategy of Figure~\ref{fig:mappingexample} (c), there is no opportunity to deactivate idle resources in any of the three intervals. However, the purely-WR strategy of Figure~\ref{fig:mappingexample} (d) may be augmented with RP, as shown in Figure~\ref{fig:mappingexample} (e), to achieve maximal savings in electricity cost. The strategy in Figure~\ref{fig:mappingexample} (e) not only shifts workload to the cheapest possible resources, but also deactivates as many resources as possible. 

In claiming that Figure~\ref{fig:mappingexample} (e) shows the maximal savings in electricity cost, we have assumed that activation and deactivation of network resources is free of cost. However, such costs may exist in practice and in some networks it may even be significant compared to the total electricity cost of network operation. In such cases, care must be taken when defining the optimal strategy for network operation. %With this in mind, we draw parallels with similar problems in other domains with known results on optimal solutions and hence draw conclusions on the computational complexity of the optimal electricity cost network operation.

Unused fractions of a network site continue to consumer power on idle. Electricity cost savings from the WR and RP strategies may be improved if unused fractions of network resources could be deactivated. For instance, the power savings of the strategy shown in Figure~\ref{fig:mappingexample} (e) can be improved by deactivating half of the resources at site B during intervals $t_2$ and $t_3$. 


\section{Optimization problem formulation}
\label{sec:framework:optimization}
On a high-level, routine network operation involves distributing workload to network sites and periodically updating the fraction of workload mapped to each network site. For simplicity of modeling and analysis, we assume that the mapping of workload to network sites, henceforth referred to as \textit{workload mapping} or simply \textit{mapping}, is updated at the beginning of intervals of fixed duration. 

We denote the status of site $i$ during interval $j$ by $p_i^j$, which may be a binary variable if the site may be either active or inactive. It may be possible to configure a site at a finer granularity, and thus, in general, $p_i^j$ may have a value between $0$ and $l$. For instance, if a data center consists of 10 pods, each of which may be independently (de)activated, $p_i^j$ may have any integer value between $0$ and $10$. If $p_i^j$ has a value equal to $c$, then exactly $c$ pods are active while others are inactive. 

We denote the workload being handled by site $i$ during interval $j$ as $x_i^j$. We refer to the status and amount of workload mapped to site $i$ at time $j$ collectively as the site's state, denoted $s_i^j$. The aggregated state of all network sites during interval $j$ may be termed as the \textit{network state} during the corresponding interval, denoted by $S^j$. The routine network operation can thus be modeled as determining a sequence of network states for a time horizon, called a \textit{planning window}, consisting of a set of consecutive intervals of equal duration. In the context of our thesis, the objective is to determine the state trajectory that is optimal in the sense that it minimizes the electricity cost over the planning window. %The interval after which the workload mapping may change need not be less than the interval during which the workload and electricity prices remain almost constant. Both problems, i.e., mapping real fractions of workload to network resources (as in the geo-diverse data center scenario) and the 0/1 mapping of workload (as in the cellular network scenario) are multi-interval allocation 

\subsection{The objective function}
\label{subsec:framework:objective} %Provide the mathematical form of the objective function that is designed to solve the optimal state trajectory problem.
The optimal state trajectory problem attempts to determine a sequence of states such that the sum of state costs and the cost of transitions between states in consecutive intervals is minimized. Mathematically, we may present the objective function as:

\begin{align}
\sum_{j=1}^n C(S^j) + T(S^j, S^{j-1})\label{eq:genobjective}
\end{align}

Here $C(S^j)$ represents a function that evaluates the cost of being in state $S^j$. As per equation~\ref{eq:abdcpaper}, $C(S^j)$ may be given as:
\begin{align}
C(S^j) = \sum_{i=1}^m \left\{ P_{min} + x_i^j (P_{max} - P_{min}) \right\}
\end{align}

Furthermore, $T(S^j,S^{j-1})$ represents a function that computes the cost of transitioning from state $S^{j-1}$ to state $S^j$ during consecutive intervals $j-1$ and $j$. The transition costs may be a result of factors such as overhead electricity consumption when turning network resources on or off. We will show in the next chapter how activation and deactivation overheads may be computed using the values of the indicator variables $p_i^j$ and $p_i^{j-1}$.

\subsection{The constraints}
\label{subsec:framework:constraints} %Comment on some of the network-specific constraints that the optimization must be subject to.
The state trajectory problem must be subject to a number of problem-specific constraints. Some constraints are common to both geo-diverse data centers and cellular networks. 

\begin{itemize}
\item \textbf{Site capacity must be respected:} During all intervals, we must ensure that the workload mapped to each network site does not exceed its capacity.
\item \textbf{All workload must be handled:} During all intervals, the sum of workload mapped to all network sites must equal the offered workload for that interval.
\item \textbf{Network site status is an integer value:} The status of a network site must be represented as an integer variable. This may be a 0/1 variable if the site may have only two states, on or off, for instance. If a resource may be configured in one of $l+1$ power-saving states, then this variable may take on integer values between $0$ and $l$. 

It might appear that the binary site status is redundant given that we are also keeping track of the workload mapped to the site as part of its state. A site may be considered off if it has zero workload and on otherwise. However, there is no linear function that can calculate the cost of resource activation and deactivation given the workload mapped to it in two consecutive intervals. One must introduce an auxiliary variable that represents resource status in order to keep the optimization formulation linear\footnote{Introduction of non-linearity in an optimization problem increases its computational complexity.}. 
\end{itemize}

Several network-specific constraints must also be formulated. These constraints arise from subtle differences between different types of network. For instance, while any client request can be handled at any data center, a given call may be handled by only a few BTSs that are in the immediate vicinity of a caller. Such constraints will be specified in later chapters.

\subsection{Comments on the problem formulation}
The decision variables in our problem formulation are the state of network sites for each interval in the planning window. A site's state has two parts: the amount of workload it handles and its status (on or off). The site status needs to be a discrete (binary or integer) variable. The amount of workload may also be a whole number in some network types. For instance, in a cellular network context, the workload mapped to a site represents the number of active calls being handled by a BTS, which is a whole number. It is also possible to formulate the problem such that the workload mapped to a site during an interval is a fraction between $0$ and $1$, representing the fraction of total workload during that interval mapped to the particular site. In the first formulation, the site state is purely discrete, whereas in the second formulation, the site state is composed of a discrete as well as real-valued parts. In the former case, our optimization problem is an integer program (IP), whereas in the latter, the problem is a mixed integer program (MIP). Both IP and MIP are NP-Hard and must be solved using techniques such as branch and bound~\cite{land60a} or other heuristics. 

If functions $C(.)$ and $T(.)$ as well as all constraints are linear and convex, the formulation is termed as an integer linear program or mixed integer linear program. Since the branch and bound technique repeatedly solves constrained and integer-relaxed versions of the IP (or MIP), linearity of the objective functions lowers the computational complexity. Fortunately, the nature of energy consumption in networks is such that the power consumption function $C(.)$ is linear and convex. For this reason, in our thesis, we strive to make the transition cost function $T(.)$ as well as all problem constraints as linear.

\section{Summary}
In this chapter, we have presented an abstract formulation of the general optimization problem for minimizing electricity cost in service provider networks. Two concrete instances of the optimization problem are discussed in the next two chapters. In order to solve both of those concrete instances, we used the CPLEX solver available with the ILOG CPLEX Studio. CPLEX solver uses the branch and bound heuristic. Our primary focus in this thesis is to investigate the potential that the use of RP and WR offers for electricity cost optimization. Therefore, we focus on solving both concrete instances of the optimization problem \textit{exactly}. As we shall see in the next two chapters, we were able to solve problems of realistic size using simple desktop PCs within a reasonable amount of time. While our primary focus is not on proposing heuristics for approximate solutions to the problem, in the next two chapters, we do propose an approximation algorithm for the optimization problem for each of networks considered in this thesis. 